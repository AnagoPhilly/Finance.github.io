<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anago Philly Finance Tools</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #dadada;
            margin: 10;
            padding: 0px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            position: relative;
        }
        header {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            background-color: #ffffff;
            min-height: 60px;
            border-bottom: 2px solid #e0e0e0;
            padding: 5px 0;
        }
        .logo { grid-column: 1; margin-left: 10px; flex-shrink: 0; }
        .logo img {
            max-width: 150px;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        h1 {
            grid-column: 2;
            justify-self: end;
            margin-right: 10px;
            font-size: 22px;
            color: #2c3e50;
            flex-shrink: 0;
        }
        .main-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0px;
            margin-top: 0px;
        }
        .main-actions h2 {
            font-size: 24px;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 40px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        button {
            padding: 15px 30px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #2980b9; }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        .button-group button {
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
        }
        #content { margin-top: 20px; }
        .hidden { display: none; }
        .back-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #666666;
            font-size: 16px;
        }
        .back-btn:hover { background-color: #c0392b; }
        .cfee-section, .pnl-section, .manhour-section, .revenue-section { margin-bottom: 20px; }
        .cfee-section h2, .cfee-section h3, .manhour-section h2, .revenue-section h2 {
            margin: 0 0 0px 0;
            font-weight: 600;
            color: #34495e;
        }
        .pnl-section h2 {
            margin: 10px 10 0px 10;
            font-weight: 600;
            color: #34495e;
        }
        .cfee-section h2, .pnl-section h2, .manhour-section h2, .revenue-section h2 {
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .cfee-section h3 { font-size: 16px; }
        .cfee-table, .pnl-table, .manhour-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
        }
        .cfee-table th, .cfee-table td, .pnl-table th, .pnl-table td, .manhour-table th, .manhour-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .cfee-table th, .pnl-table th, .manhour-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        .cfee-table td, .pnl-table td, .manhour-table td {
            background-color: #ffffff;
            text-align: right;
        }
        .highlight {
            background-color: #f1f9ff;
            font-weight: 600;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            box-sizing: border-box;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }
        .cfee-actions, .pnl-actions, .manhour-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background-color: #ffffff;
        }
        .payment-option {
            background-color: #F5F5F5;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            page-break-inside: avoid;
        }
        .most-common {
            font-style: italic;
            color: #7f8c8d;
            margin-top: -5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .accordion {
            background-color: #ffffff;
            color: #444;
            cursor: pointer;
            padding: 8px;
            width: 100%;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            text-align: left;
            outline: none;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.4s ease;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }
        .accordion:hover, .accordion.active { background-color: #e9ecef; }
        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .account-name-input {
            width: calc(100% - 20px);
            margin: 10px 0;
            padding: 5px;
        }
        .add-account-btn {
            padding: 10px 20px;
            background-color: #3498db;
            margin: 10px 0;
        }
        .add-account-btn:hover { background-color: #2980b9; }
        .pnl-form, .revenue-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .pnl-form label, .revenue-form label {
            margin-bottom: 5px;
        }
        .remove-account-btn {
            padding: 5px 10px;
            background-color: #2980b9;
            font-size: 12px;
            margin-left: 10px;
            border-radius: 3px;
        }
        .remove-account-btn:hover { background-color: #c0392b; }
        .cfee-input-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .cfee-input-group div {
            flex: 1;
            min-width: 150px;
        }
        .year-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .year-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .year-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .year-btn:hover { background-color: #2980b9; }
        .year-btn.active { background-color: #2c3e50; }

        @media screen and (min-width: 768px) {
            .container { padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            .logo img { max-width: 220px; }
            h1 { font-size: 28px; }
            .main-actions h2 { font-size: 28px; }
            .main-actions button { padding: 20px 40px; font-size: 20px; }
            .button-group {
                flex-direction: row;
                justify-content: center;
                gap: 20px;
                max-width: 800px;
            }
            .button-group button {
                width: 200px;
            }
            .cfee-section h2, .pnl-section h2, .manhour-section h2, .revenue-section h2 { font-size: 24px; }
            .cfee-section h3 { font-size: 20px; }
            .cfee-table th, .cfee-table td, .pnl-table th, .pnl-table td, .manhour-table th, .manhour-table td {
                padding: 15px;
                font-size: 20px;
            }
            input[type="text"], input[type="number"] {
                padding: 15px;
                margin: 8px 0;
                border-radius: 8px;
                font-size: 20px;
            }
            .accordion {
                padding: 15px;
                font-size: 20px;
                border-radius: 8px;
            }
            .cfee-actions, .pnl-actions, .manhour-actions { gap: 15px; margin-bottom: 30px; }
            .cfee-actions button, .pnl-actions button, .manhour-actions button {
                padding: 12px 25px;
                font-size: 16px;
                border-radius: 6px;
            }
            .payment-option { padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
            .most-common { margin-top: 5px; margin-bottom: 15px; font-size: 16px; }
            .back-btn { bottom: 20px; right: 40px; }
            .year-btn { padding: 12px 25px; font-size: 16px; }
        }
        @media print {
            .main-actions, .cfee-actions, .pnl-actions, .manhour-actions, .back-btn, .add-account-btn, .remove-account-btn, .year-selector, .year-buttons { display: none !important; }
            #cfee-content:not(.hidden) ~ #pnl-content, #cfee-content:not(.hidden) ~ #manhour-content, #cfee-content:not(.hidden) ~ #revenue-content { display: none !important; }
            #pnl-content:not(.hidden) ~ #cfee-content, #pnl-content:not(.hidden) ~ #manhour-content, #pnl-content:not(.hidden) ~ #revenue-content { display: none !important; }
            #manhour-content:not(.hidden) ~ #cfee-content, #manhour-content:not(.hidden) ~ #pnl-content, #manhour-content:not(.hidden) ~ #revenue-content { display: none !important; }
            #revenue-content:not(.hidden) ~ #cfee-content, #revenue-content:not(.hidden) ~ #pnl-content, #revenue-content:not(.hidden) ~ #manhour-content { display: none !important; }
            .container { width: 100%; max-width: 680px; padding: 15px; margin: 0 auto; box-shadow: none; border-radius: 0; }
            header { border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 5px; }
            .logo img { max-width: 160px; }
            h1 { font-size: 22px; }
            .main-actions h2 { font-size: 20px; }
            .cfee-section h2, .cfee-section h3, .pnl-section h2, .manhour-section h2, .revenue-section h2 { font-size: 16px; margin: 0 0 8px 0; }
            .cfee-section h2, .pnl-section h2, .manhour-section h2, .revenue-section h2 { padding-bottom: 4px; }
            .cfee-section, .pnl-section, .manhour-section, .revenue-section { margin-bottom: 15px; }
            .cfee-table, .pnl-table, .manhour-table { margin-top: 8px; }
            .cfee-table th, .cfee-table td, .pnl-table th, .pnl-table td, .manhour-table th, .manhour-table td { padding: 8px; font-size: 12px; }
            input[type="text"], input[type="number"] {
                padding: 6px;
                margin: 2px 0;
                border-radius: 4px;
                font-size: 12px;
            }
            .accordion {
                padding: 6px;
                font-size: 12px;
                border-radius: 4px;
            }
            .payment-option { padding: 12px; border-radius: 5px; box-shadow: none; margin-bottom: 12px; }
            .most-common { margin-top: -4px; margin-bottom: 4px; font-size: 10px; }
            .panel { max-height: none !important; }
            @page { size: A4 portrait; margin: 2mm; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="https://cdn-ilafcfb.nitrocdn.com/KEhcwwSaSxLtwUeasrlkkKIKKhAgEOob/assets/images/optimized/rev-16fc74f/anagocleaning.com/wp-content/uploads/2023/09/anagologo2-300x181.png" alt="Anago Cleaning Systems Logo">
            </div>
            <h1>Anago Philly Finance Tools</h1>
        </header>

        <section class="main-actions" id="main-actions">
            <h2>Main Menu</h2>
            <div class="button-group">
                <button id="manhour-btn">Man Hour Calculator</button>
                <button id="cfee-btn">C-Fee Calculator</button>
                <button id="pnl-btn">P&L Statement</button>
                <button id="revenue-btn">Revenue Analysis</button>
            </div>
        </section>

        <div id="content">
            <div id="cfee-content" class="hidden">
                <section class="cfee-section">
                    <h2>Account Information:</h2>
                    <form>
                        <label for="account-name">Account Name:</label>
                        <input type="text" id="account-name" name="account-name" value=" ">
                        <div class="cfee-input-group">
                            <div>
                                <label for="monthly-amount">Monthly Account Amount:</label>
                                <input type="text" id="monthly-amount" name="monthly-amount" value="0.00">
                            </div>
                            <div>
                                <label for="cfi-factor">CFI Factor:</label>
                                <input type="number" id="cfi-factor" name="cfi-factor" value="0.0" step="0.1">
                            </div>
                        </div>
                    </form>
                </section>
                <section class="cfee-actions">
                    <button id="calculate-btn">Calculate</button>
                    <button id="print-btn">Print</button>
                    <button id="download-btn">Download</button>
                </section>
                <section class="payment-option cfee-section">
                    <h3>Cash Payment</h3>
                    <table class="cfee-table">
                        <tr><th>C-fee Amount (<span id="cfi-factor-cash">0.0</span> x $<span id="cfee-applied-cash">0.00</span>)</th><td id="cfee-amount-cash">$0.00</td></tr>
                        <tr><th>Cash Discount (15%)</th><td id="cash-discount">($0.00)</td></tr>
                        <tr class="highlight"><th>Total Due</th><td id="total-due-cash">$0.00</td></tr>
                    </table>
                </section>
                <section class="payment-option cfee-section">
                    <h3>120 Days No Interest</h3>
                    <table class="cfee-table">
                        <tr><th>C-fee Amount (<span id="cfi-factor-120">0.0</span> x $<span id="cfee-applied-120">0.00</span>)</th><td id="cfee-amount-120">$0.00</td></tr>
                        <tr><th>Payment Amount (4 months)</th><td id="payment-amount-120">0.00</td></tr>
                    </table>
                </section>
                <section class="payment-option cfee-section">
                    <h3>Financed (12 Months)</h3>
                    <p class="most-common">Most Common Option</p>
                    <table class="cfee-table">
                        <tr><th>C-fee Amount (<span id="cfi-factor-financed">0.0</span> x $<span id="cfee-applied-financed">0.00</span>)</th><td id="cfee-amount-financed">$0.00</td></tr>
                        <tr><th>12% Interest</th><td id="interest">$0.00</td></tr>
                        <tr><th>Financed Total</th><td id="financed-total">$0.00</td></tr>
                        <tr><th>Monthly Payment (12 months)</th><td id="monthly-payment-financed">$0.00</td></tr>
                    </table>
                </section>
                <button id="cfee-back-btn" class="back-btn">Back</button>
            </div>

            <div id="pnl-content" class="hidden">
                <section class="pnl-section">
                    <h2>Profit & Loss Statement</h2>
                    <div id="accounts-container">
                        <button class="accordion">Account 1</button>
                        <div class="panel">
                            <input type="text" class="account-name-input" value="Account 1">
                            <form class="pnl-form">
                                <div>
                                    <label>Total Revenue (Cleaning Services):</label>
                                    <input type="text" class="number-input revenue-input" value="0.00">
                                    <label>Labor Costs:</label>
                                    <input type="text" class="number-input labor-input" value="0.00">
                                    <label>Supplies:</label>
                                    <input type="text" class="number-input supplies-input" value="0.00">
                                </div>
                                <div>
                                    <label>Overhead Expenses:</label>
                                    <input type="text" class="number-input overhead-input" value="0.00">
                                    <label>Cfees:</label>
                                    <input type="text" class="number-input cfees-input" value="0.00">
                                    <label>Cost of Doing Business (%):</label>
                                    <input type="number" class="codb-input" value="0" step="0">
                                </div>
                            </form>
                        </div>
                    </div>
                    <button id="add-account-btn" class="add-account-btn">Add Additional Account</button>
                </section>

                <section class="pnl-actions">
                    <button id="pnl-calculate-btn">Calculate</button>
                    <button id="pnl-print-btn">Print</button>
                    <button id="pnl-download-btn">Download</button>
                </section>

                <section class="pnl-section">
                    <table class="pnl-table">
                        <tr><th>Total Revenue</th><td id="pnl-total-revenue">$0.00</td></tr>
                        <tr><th>Labor Costs</th><td id="pnl-labor-costs">$0.00</td></tr>
                        <tr><th>Supplies</th><td id="pnl-supplies-costs">$0.00</td></tr>
                        <tr><th>Overhead Expenses</th><td id="pnl-overhead-costs">$0.00</td></tr>
                        <tr><th>Cfees</th><td id="pnl-cfees-costs">$0.00</td></tr>
                        <tr><th>Cost of Doing Business</th><td id="pnl-codb-costs">$0.00</td></tr>
                        <tr><th>Total Expenses</th><td id="pnl-total-expenses">$0.00</td></tr>
                        <tr class="highlight"><th>Net Profit (With CFees)</th><td id="pnl-net-profit">$0.00</td></tr>
                        <tr class="highlight"><th>Net Profit (Without CFees)</th><td id="pnl-net-without-cfees">$0.00</td></tr>
                    </table>
                </section>
                <button id="pnl-back-btn" class="back-btn">Back</button>
            </div>

            <div id="manhour-content" class="hidden">
                <section class="manhour-section">
                    <h2>Man Hour Calculator</h2>
                    <form>
                        <label for="number-of-people">Number of People:</label>
                        <input type="number" id="number-of-people" name="number-of-people" value="0" step="1">
                        <label for="total-hours">Total Number of Hours:</label>
                        <input type="number" id="total-hours" name="total-hours" value="0.0" step="0.1">
                    </form>
                </section>
                <section class="manhour-actions">
                    <button id="manhour-calculate-btn">Calculate</button>
                </section>
                <section class="manhour-section">
                    <table class="manhour-table">
                        <tr><th>Total Man Hours</th><td id="total-man-hours">0.0</td></tr>
                    </table>
                </section>
                <button id="manhour-back-btn" class="back-btn">Back</button>
            </div>

            <div id="revenue-content" class="hidden">
                <section class="revenue-section">
                    <h2>Revenue Analysis</h2>
                    <div class="year-selector">
                        <div>
                            <label for="start-year">Start Year:</label>
                            <input type="number" id="start-year" value="2024" min="1900" max="2100">
                        </div>
                        <div>
                            <label for="end-year">End Year:</label>
                            <input type="number" id="end-year" value="2025" min="1900" max="2100">
                        </div>
                        <button id="generate-years">Generate Years</button>
                        <button id="analysis-report-btn">Analysis Report</button>
                        <input type="file" id="import-excel" accept=".xlsx, .xls" style="display: none;">
                        <button id="import-btn">Import Excel</button>
                        <button id="paste-data-btn">Paste Data</button>
                    </div>
                    <textarea id="paste-data-input" rows="4" cols="50" placeholder="Paste Excel data here (e.g., MM-DD-YY<tab>Amount)" style="display: none; margin-top: 10px;"></textarea>
                    <div id="year-buttons" class="year-buttons"></div>
                    <div id="months-container"></div>
                </section>
                <button id="revenue-back-btn" class="back-btn">Back</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;

            const mainActions = document.getElementById('main-actions');
            const cfeeBtn = document.getElementById('cfee-btn');
            const pnlBtn = document.getElementById('pnl-btn');
            const manhourBtn = document.getElementById('manhour-btn');
            const revenueBtn = document.getElementById('revenue-btn');
            const cfeeContent = document.getElementById('cfee-content');
            const pnlContent = document.getElementById('pnl-content');
            const manhourContent = document.getElementById('manhour-content');
            const revenueContent = document.getElementById('revenue-content');
            const cfeeBackBtn = document.getElementById('cfee-back-btn');
            const pnlBackBtn = document.getElementById('pnl-back-btn');
            const manhourBackBtn = document.getElementById('manhour-back-btn');
            const revenueBackBtn = document.getElementById('revenue-back-btn');

            const calculateBtn = document.getElementById('calculate-btn');
            const printBtn = document.getElementById('print-btn');
            const downloadBtn = document.getElementById('download-btn');
            const container = document.querySelector('.container');
            const actionsSection = document.querySelector('.cfee-actions');

            const startYearInput = document.getElementById('start-year');
            const endYearInput = document.getElementById('end-year');
            const generateYearsBtn = document.getElementById('generate-years');
            const analysisReportBtn = document.getElementById('analysis-report-btn');
            const yearButtonsContainer = document.getElementById('year-buttons');
            const monthsContainer = document.getElementById('months-container');
            const importBtn = document.getElementById('import-btn');
            const importExcelInput = document.getElementById('import-excel');
            const pasteDataBtn = document.getElementById('paste-data-btn');
            const pasteDataInput = document.getElementById('paste-data-input');

            // Navigation
            cfeeBtn.addEventListener('click', () => toggleSection(cfeeContent));
            pnlBtn.addEventListener('click', () => toggleSection(pnlContent));
            manhourBtn.addEventListener('click', () => toggleSection(manhourContent));
            revenueBtn.addEventListener('click', () => toggleSection(revenueContent));
            cfeeBackBtn.addEventListener('click', () => toggleSection(mainActions));
            pnlBackBtn.addEventListener('click', () => toggleSection(mainActions));
            manhourBackBtn.addEventListener('click', () => toggleSection(mainActions));
            revenueBackBtn.addEventListener('click', () => toggleSection(mainActions));

            function toggleSection(activeSection) {
                mainActions.classList.toggle('hidden', activeSection !== mainActions);
                cfeeContent.classList.toggle('hidden', activeSection !== cfeeContent);
                pnlContent.classList.toggle('hidden', activeSection !== pnlContent);
                manhourContent.classList.toggle('hidden', activeSection !== manhourContent);
                revenueContent.classList.toggle('hidden', activeSection !== revenueContent);
            }

            let accCount = 1;

            function toggleAccordion() {
                this.classList.toggle('active');
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                }
            }

            function formatNumberInputs(container) {
                const numberInputs = container.querySelectorAll('.number-input');
                numberInputs.forEach(input => {
                    input.addEventListener('blur', () => {
                        const value = parseFloat(input.value.replace(/,/g, '')) || 0;
                        input.value = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    });
                });
            }

            // P&L Setup
            document.querySelectorAll('#accounts-container .accordion').forEach(acc => {
                acc.addEventListener('click', toggleAccordion);
            });

            document.getElementById('add-account-btn').addEventListener('click', () => {
                accCount++;
                const newAcc = document.createElement('button');
                newAcc.className = 'accordion';
                newAcc.innerHTML = `<span class="accordion-title">Account ${accCount}</span><button class="remove-account-btn">Remove</button>`;
                const newPanel = document.createElement('div');
                newPanel.className = 'panel';
                newPanel.innerHTML = `
                    <input type="text" class="account-name-input" value="Account ${accCount}">
                    <form class="pnl-form">
                        <div>
                            <label>Total Revenue (Cleaning Services):</label>
                            <input type="text" class="number-input revenue-input" value="0.00">
                            <label>Labor Costs:</label>
                            <input type="text" class="number-input labor-input" value="0.00">
                            <label>Supplies:</label>
                            <input type="text" class="number-input supplies-input" value="0.00">
                        </div>
                        <div>
                            <label>Overhead Expenses:</label>
                            <input type="text" class="number-input overhead-input" value="0.00">
                            <label>Cfees:</label>
                            <input type="text" class="number-input cfees-input" value="0.00">
                            <label>Cost of Doing Business (%):</label>
                            <input type="number" class="codb-input" value="0" step="0">
                        </div>
                    </form>
                `;
                document.getElementById('accounts-container').appendChild(newAcc);
                document.getElementById('accounts-container').appendChild(newPanel);

                newAcc.addEventListener('click', toggleAccordion);
                newPanel.querySelector('.account-name-input').addEventListener('input', function() {
                    newAcc.querySelector('.accordion-title').textContent = this.value || `Account ${accCount}`;
                });
                newAcc.querySelector('.remove-account-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    newAcc.remove();
                    newPanel.remove();
                    accCount--;
                });
                formatNumberInputs(newPanel);
            });

            formatNumberInputs(document);

            // Revenue Analysis
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            let revenueData = {};

            function generateMonthTabs(year) {
                monthsContainer.innerHTML = '';
                months.forEach(month => {
                    const key = `${month} ${year}`;
                    if (!revenueData[key]) {
                        revenueData[key] = { profit: 0, labor: 0, expenses: 0 };
                    }
                    const accordion = document.createElement('button');
                    accordion.className = 'accordion';
                    accordion.textContent = key;
                    const panel = document.createElement('div');
                    panel.className = 'panel';
                    panel.innerHTML = `
                        <form class="revenue-form">
                            <div>
                                <label>Profit:</label>
                                <input type="text" class="number-input profit-input" value="${revenueData[key].profit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}">
                                <label>Labor:</label>
                                <input type="text" class="number-input labor-input" value="${revenueData[key].labor.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}">
                                <label>Expenses:</label>
                                <input type="text" class="number-input expenses-input" value="${revenueData[key].expenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}">
                            </div>
                        </form>
                    `;
                    monthsContainer.appendChild(accordion);
                    monthsContainer.appendChild(panel);
                    accordion.addEventListener('click', toggleAccordion);

                    const inputs = panel.querySelectorAll('.number-input');
                    inputs.forEach(input => {
                        input.addEventListener('blur', () => {
                            const value = parseFloat(input.value.replace(/,/g, '')) || 0;
                            input.value = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            if (input.classList.contains('profit-input')) revenueData[key].profit = value;
                            if (input.classList.contains('labor-input')) revenueData[key].labor = value;
                            if (input.classList.contains('expenses-input')) revenueData[key].expenses = value;
                        });
                    });
                });
                console.log(`Generated tabs for ${year}:`, revenueData);
            }

            function generateYearButtons(startYear, endYear) {
                yearButtonsContainer.innerHTML = '';
                for (let year = startYear; year <= endYear; year++) {
                    const btn = document.createElement('button');
                    btn.className = 'year-btn';
                    btn.textContent = year;
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        generateMonthTabs(year);
                    });
                    yearButtonsContainer.appendChild(btn);
                }
                const firstBtn = yearButtonsContainer.querySelector('.year-btn');
                if (firstBtn) {
                    firstBtn.classList.add('active');
                    generateMonthTabs(startYear);
                }
            }

            generateYearsBtn.addEventListener('click', () => {
                const startYear = parseInt(startYearInput.value) || 2015;
                const endYear = parseInt(endYearInput.value) || 2025;
                if (startYear <= endYear) {
                    generateYearButtons(startYear, endYear);
                } else {
                    alert('Start Year must be less than or equal to End Year');
                }
            });

            analysisReportBtn.addEventListener('click', () => {
                const startYear = parseInt(startYearInput.value) || 2015;
                const endYear = parseInt(endYearInput.value) || 2025;
                const reportData = [];
                for (let year = startYear; year <= endYear; year++) {
                    months.forEach(month => {
                        const key = `${month} ${year}`;
                        if (revenueData[key]) {
                            reportData.push({
                                label: key,
                                profit: revenueData[key].profit,
                                labor: revenueData[key].labor,
                                expenses: revenueData[key].expenses
                            });
                        }
                    });
                }
                const encodedData = encodeURIComponent(JSON.stringify(reportData));
                window.open(`analysis-report.html?data=${encodedData}`, '_blank');
            });

            // Import Excel functionality
            importBtn.addEventListener('click', () => {
                importExcelInput.click();
            });

            importExcelInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', dateNF: 'mm/dd/yyyy' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: ['Date', 'Amount'], range: 0, raw: false, dateNF: 'mm/dd/yyyy' });

                        console.log('Raw JSON data from Excel:', jsonData);

                        const aggregatedData = {};
                        jsonData.forEach((row, index) => {
                            if (index === 0) return;

                            let dateStr = row['Date'];
                            let amount = row['Amount'];

                            if (typeof amount === 'string') {
                                amount = parseFloat(amount.replace(/,/g, '')) || 0;
                            } else if (typeof amount !== 'number') {
                                console.warn(`Invalid amount at row ${index + 1}:`, amount);
                                amount = 0;
                            }

                            if (typeof dateStr === 'number') {
                                const date = XLSX.SSF.parse_date_code(dateStr);
                                if (date) {
                                    dateStr = `${date.m}/${date.d}/${date.y}`;
                                } else {
                                    console.warn(`Invalid date number at row ${index + 1}:`, dateStr);
                                    return;
                                }
                            } else if (typeof dateStr !== 'string') {
                                console.warn(`Invalid date format at row ${index + 1}:`, dateStr);
                                return;
                            }

                            let dateParts = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
                            const month = parseInt(dateParts[0], 10);
                            const year = parseInt(dateParts[2], 10);
                            const fullYear = year < 100 ? 2000 + year : year;
                            const monthName = months[month - 1];

                            if (!monthName) {
                                console.warn(`Invalid month at row ${index + 1}:`, month);
                                return;
                            }

                            const key = `${monthName} ${fullYear}`;
                            if (!aggregatedData[key]) {
                                aggregatedData[key] = { profit: 0, labor: 0, expenses: 0 };
                            }
                            aggregatedData[key].profit += amount;
                        });

                        Object.keys(aggregatedData).forEach(key => {
                            revenueData[key] = {
                                profit: aggregatedData[key].profit,
                                labor: revenueData[key]?.labor || 0,
                                expenses: revenueData[key]?.expenses || 0
                            };
                        });

                        const activeYearBtn = yearButtonsContainer.querySelector('.year-btn.active');
                        if (activeYearBtn) {
                            const activeYear = parseInt(activeYearBtn.textContent);
                            generateMonthTabs(activeYear);
                        } else {
                            alert('Please select a year to display the imported data.');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                    importExcelInput.value = '';
                }
            });

            // Paste Data functionality
            pasteDataBtn.addEventListener('click', () => {
                if (pasteDataInput.style.display === 'none' || pasteDataInput.style.display === '') {
                    pasteDataInput.style.display = 'block';
                    pasteDataBtn.textContent = 'Submit Pasted Data';
                } else {
                    const pastedText = pasteDataInput.value.trim();
                    if (pastedText) {
                        processPastedData(pastedText);
                        pasteDataInput.style.display = 'none';
                        pasteDataBtn.textContent = 'Paste Data';
                        pasteDataInput.value = '';
                    } else {
                        alert('Please paste some data before submitting.');
                    }
                }
            });

            function processPastedData(text) {
                console.log('Pasted text:', text);
                const lines = text.split('\n');
                const aggregatedData = {};

                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;

                    let parts = trimmedLine.split(/\t/); // Assuming tab-separated as per your example
                    console.log(`Line ${index + 1} parts:`, parts);

                    if (parts.length < 2) {
                        console.warn(`Invalid data format at line ${index + 1}:`, trimmedLine);
                        return;
                    }

                    let [dateStr, amountStr] = parts;
                    let amount = parseFloat(amountStr.replace(/,/g, '')) || 0;

                    let dateParts = dateStr.split('-');
                    if (dateParts.length !== 3) {
                        console.warn(`Invalid date format at line ${index + 1}:`, dateStr);
                        return;
                    }

                    const month = parseInt(dateParts[0], 10); // MM
                    const year = parseInt(dateParts[2], 10);  // YY
                    const fullYear = year < 100 ? 2000 + year : year; // Convert YY to YYYY
                    const monthName = months[month - 1];

                    if (!monthName) {
                        console.warn(`Invalid month at line ${index + 1}:`, month);
                        return;
                    }

                    const key = `${monthName} ${fullYear}`;
                    if (!aggregatedData[key]) {
                        aggregatedData[key] = { profit: 0, labor: 0, expenses: 0 };
                    }
                    aggregatedData[key].profit += amount;
                    console.log(`Processed ${key}: Profit += ${amount}`);
                });

                Object.keys(aggregatedData).forEach(key => {
                    revenueData[key] = {
                        profit: aggregatedData[key].profit,
                        labor: revenueData[key]?.labor || 0,
                        expenses: revenueData[key]?.expenses || 0
                    };
                });

                console.log('Updated revenueData:', revenueData);

                const activeYearBtn = yearButtonsContainer.querySelector('.year-btn.active');
                if (activeYearBtn) {
                    const activeYear = parseInt(activeYearBtn.textContent);
                    generateMonthTabs(activeYear);
                } else {
                    // Default to the earliest year in the data if no year is selected
                    const years = Object.keys(revenueData).map(key => parseInt(key.split(' ')[1])).sort();
                    const defaultYear = years.length ? years[0] : parseInt(startYearInput.value) || 2024;
                    generateYearButtons(defaultYear, parseInt(endYearInput.value) || defaultYear);
                    generateMonthTabs(defaultYear);
                }
            }

            // Initialize with default range (updated to 2024-2025 to match your data)
            generateYearButtons(2024, 2025);

            // C-Fee Calculator
            calculateBtn.addEventListener('click', () => {
                const monthlyAmount = parseFloat(document.getElementById('monthly-amount').value.replace(/,/g, '')) || 0;
                const cfiFactor = parseFloat(document.getElementById('cfi-factor').value) || 0;
                const cfeeAmount = monthlyAmount * cfiFactor;
                const cashDiscountValue = cfeeAmount * 0.15;
                const totalDue = cfeeAmount - cashDiscountValue;
                const paymentAmount = cfeeAmount / 4;
                const interestValue = cfeeAmount * 0.12;
                const financedTotalValue = cfeeAmount + interestValue;
                const monthlyPayment = financedTotalValue / 12;

                document.getElementById('cfi-factor-cash').textContent = cfiFactor.toFixed(2);
                document.getElementById('cfee-applied-cash').textContent = monthlyAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('cfee-amount-cash').textContent = `$${cfeeAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('cash-discount').textContent = `($${cashDiscountValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
                document.getElementById('total-due-cash').textContent = `$${totalDue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('cfi-factor-120').textContent = cfiFactor.toFixed(2);
                document.getElementById('cfee-applied-120').textContent = monthlyAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('cfee-amount-120').textContent = `$${cfeeAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('payment-amount-120').textContent = paymentAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('cfi-factor-financed').textContent = cfiFactor.toFixed(2);
                document.getElementById('cfee-applied-financed').textContent = monthlyAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('cfee-amount-financed').textContent = `$${cfeeAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('interest').textContent = `$${interestValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('financed-total').textContent = `$${financedTotalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('monthly-payment-financed').textContent = `$${monthlyPayment.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            });

            printBtn.addEventListener('click', () => window.print());
            downloadBtn.addEventListener('click', async () => {
                actionsSection.style.display = 'none';
                cfeeBackBtn.style.display = 'none';
                const canvas = await html2canvas(container, { backgroundColor: '#ffffff', scale: 2, useCORS: true, scrollY: 0, scrollX: 0 });
                actionsSection.style.display = 'flex';
                cfeeBackBtn.style.display = 'block';
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = 210;
                const pageHeight = 297;
                const imgWidth = pageWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft > 0) {
                    position = -(pageHeight - (heightLeft > pageHeight ? pageHeight : heightLeft));
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, heightLeft > pageHeight ? pageHeight : heightLeft);
                    heightLeft -= pageHeight;
                }
                pdf.save('C-Fee_Statement.pdf');
            });

            // P&L Calculator
            document.getElementById('pnl-calculate-btn').addEventListener('click', () => {
                let totalRevenue = 0, totalLabor = 0, totalSupplies = 0, totalOverhead = 0, totalCfees = 0, totalCodbCost = 0;
                document.querySelectorAll('.pnl-form').forEach(form => {
                    const revenue = parseFloat(form.querySelector('.revenue-input').value.replace(/,/g, '')) || 0;
                    const labor = parseFloat(form.querySelector('.labor-input').value.replace(/,/g, '')) || 0;
                    const supplies = parseFloat(form.querySelector('.supplies-input').value.replace(/,/g, '')) || 0;
                    const overhead = parseFloat(form.querySelector('.overhead-input').value.replace(/,/g, '')) || 0;
                    const cfees = parseFloat(form.querySelector('.cfees-input').value.replace(/,/g, '')) || 0;
                    const codbPercentage = parseFloat(form.querySelector('.codb-input').value) || 0;
                    const codbCost = (codbPercentage / 100) * revenue;

                    totalRevenue += revenue;
                    totalLabor += labor;
                    totalSupplies += supplies;
                    totalOverhead += overhead;
                    totalCfees += cfees;
                    totalCodbCost += codbCost;
                });
                const totalExpenses = totalLabor + totalSupplies + totalOverhead + totalCfees + totalCodbCost;
                const netProfit = totalRevenue - totalExpenses;
                const netWithoutCfees = netProfit + totalCfees;

                document.getElementById('pnl-total-revenue').textContent = `$${totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-labor-costs').textContent = `$${totalLabor.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-supplies-costs').textContent = `$${totalSupplies.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-overhead-costs').textContent = `$${totalOverhead.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-cfees-costs').textContent = `$${totalCfees.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-codb-costs').textContent = `$${totalCodbCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-total-expenses').textContent = `$${totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-net-profit').textContent = `$${netProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('pnl-net-without-cfees').textContent = `$${netWithoutCfees.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            });

            document.getElementById('pnl-print-btn').addEventListener('click', () => window.print());
            document.getElementById('pnl-download-btn').addEventListener('click', async () => {
                const canvas = await html2canvas(pnlContent, { backgroundColor: '#ffffff', scale: 2, useCORS: true, scrollY: 0, scrollX: 0 });
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = 210;
                const imgWidth = pageWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, 0, imgWidth, imgHeight);
                pdf.save('P&L_Statement.pdf');
            });

            // Man Hour Calculator
            document.getElementById('manhour-calculate-btn').addEventListener('click', () => {
                const numberOfPeople = parseFloat(document.getElementById('number-of-people').value) || 0;
                const totalHours = parseFloat(document.getElementById('total-hours').value) || 0;
                const totalManHours = numberOfPeople * totalHours;
                document.getElementById('total-man-hours').textContent = totalManHours.toFixed(1);
            });
        });
    </script>
</body>
</html>
